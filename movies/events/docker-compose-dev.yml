---
version: '3.9'

services:
  rabbitmq:
    image: rabbitmq:management
    env_file:
      - .env
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: rabbitmq-diagnostics -q status && rabbitmq-diagnostics -q check_local_alarms
      interval: 60s
      timeout: 30s
      retries: 3

  epk_api:
    build:
      context: ./epk_api
      dockerfile: ./Dockerfile
    restart: always
    env_file:
      - .env
    ports:
    -   "8001:8000"
    healthcheck:
      test: [CMD-SHELL, curl -sS http://127.0.0.1:8000/health_check/v1 || exit 1]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      rabbitmq:
        condition: service_healthy